<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let localStream;
    let screenStream;
    const peerConnections = {};
    const sharedStreams = {}; // Diğer kullanıcılardan gelen ekran akışlarını saklamak için
    const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const usernameInput = document.getElementById('username-input');
    const saveUsernameBtn = document.getElementById('saveUsernameBtn');
    const userList = document.getElementById('userList');
    const otherUsersList = document.getElementById('otherUsersList');
    const usernameContainer = document.getElementById('username-container');
    const myControlsDiv = document.querySelector('.my-controls');
    const myUsernameSpan = document.getElementById('my-username');
    const toggleMicBtn = document.getElementById('toggle-mic-btn');
    const shareScreenBtn = document.getElementById('share-screen-btn');
    const callBtn = document.getElementById('callBtn');
    const sharedScreenContainer = document.getElementById('shared-screen-container');

    let username = '';
    let isMicMuted = true;
    let isScreenSharing = false;
    
    const audioConstraints = {
        audio: {
            noiseSuppression: true
        }
    };

    const forbiddenUsernames = ['yarrak', 'siktir', 'orospu', 'amcık', 'am', 'allah', 'amk', 'sg', 'ananı', 'sikeyim', 'ananısikeyim'];

    window.onload = () => {
        const savedUsername = localStorage.getItem('username');
        if (savedUsername) {
            username = savedUsername;
            socket.emit('set-username', username);
            usernameContainer.style.display = 'none';
        }
    };

    saveUsernameBtn.onclick = () => {
        const enteredUsername = usernameInput.value.trim().toLowerCase();
        if (!enteredUsername) {
            alert('Lütfen bir kullanıcı adı girin.');
            return;
        }
        const isForbidden = forbiddenUsernames.some(word => enteredUsername.includes(word));
        if (isForbidden) {
            alert('Bu kullanıcı adı uygunsuz kelimeler içeriyor. Lütfen başka bir isim seçin.');
            return;
        }
        username = enteredUsername;
        localStorage.setItem('username', username);
        socket.emit('set-username', username);
        alert('Kullanıcı adınız kaydedildi: ' + username);
        usernameContainer.style.display = 'none';
    };

    sendButton.onclick = () => {
        const message = messageInput.value;
        if (message) {
            const messageData = { username: username || 'anonim', text: message };
            socket.emit('message', messageData);
            messageInput.value = '';
        }
    };

    socket.on('message', data => {
        const messageElement = document.createElement('div');
        messageElement.innerText = `${data.username}: ${data.text}`;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
    
    socket.on('user-list-update', users => {
        userList.innerHTML = '';
        otherUsersList.innerHTML = '';

        users.forEach(user => {
            const li = document.createElement('li');
            li.innerText = user.username;
            userList.appendChild(li);

            if (user.username !== username) {
                const liOther = document.createElement('li');
                liOther.innerText = user.username;
                liOther.setAttribute('data-username', user.username);
                
                if (user.isSharing) {
                     const watchBtn = document.createElement('button');
                     watchBtn.className = 'watch-btn';
                     watchBtn.innerText = 'İzle';
                     liOther.appendChild(watchBtn);
                }
                otherUsersList.appendChild(liOther);
            }
        });
        
        document.querySelectorAll('.watch-btn').forEach(btn => {
            btn.onclick = (e) => {
                const targetUsername = e.target.closest('li').getAttribute('data-username');
                toggleWatchScreen(targetUsername);
            };
        });
    });

    function toggleWatchScreen(targetUsername) {
        const existingVideo = document.querySelector(`video[data-username="${targetUsername}"]`);
        if (existingVideo) {
            existingVideo.remove();
            const watchBtn = document.querySelector(`li[data-username="${targetUsername}"] .watch-btn`);
            if (watchBtn) {
                watchBtn.innerText = 'İzle';
                watchBtn.classList.remove('watching-btn');
            }
        } else {
            const stream = sharedStreams[targetUsername];
            if (stream) {
                const video = document.createElement("video");
                video.srcObject = stream;
                video.autoplay = true;
                video.playsinline = true;
                video.muted = true;
                video.setAttribute('data-username', targetUsername);
                sharedScreenContainer.appendChild(video);

                const watchBtn = document.querySelector(`li[data-username="${targetUsername}"] .watch-btn`);
                if (watchBtn) {
                    watchBtn.innerText = 'Durdur';
                    watchBtn.classList.add('watching-btn');
                }
            } else {
                alert("Ekran paylaşımı henüz başlamamış veya bir sorun oluştu.");
            }
        }
    }
    
    toggleMicBtn.onclick = () => {
        if (localStream) {
            isMicMuted = !isMicMuted;
            localStream.getAudioTracks().forEach(track => track.enabled = !isMicMuted);
            toggleMicBtn.innerText = isMicMuted ? 'Sesi Aç' : 'Sesi Kapat';
            toggleMicBtn.classList.toggle('active');
        }
    };

    shareScreenBtn.onclick = async () => {
        if (isScreenSharing) {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
            }
            isScreenSharing = false;
            shareScreenBtn.innerText = "Ekran Paylaş";
            shareScreenBtn.classList.remove("sharing");
            socket.emit('stop-screen-share');
            screenStream = null;
        } else {
            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                isScreenSharing = true;
                shareScreenBtn.innerText = "Paylaşımı Durdur";
                shareScreenBtn.classList.add("sharing");
                socket.emit('start-screen-share');
                
                for (const peerId in peerConnections) {
                    const peer = peerConnections[peerId];
                    screenStream.getTracks().forEach(track => {
                        peer.addTrack(track, screenStream);
                    });
                }

                screenStream.getVideoTracks()[0].onended = () => {
                    shareScreenBtn.click();
                };
            } catch (e) {
                console.error("Ekran paylaşımı başlatılamadı:", e);
                alert("Ekran paylaşımı için izin vermeniz gerekiyor!");
            }
        }
    };
    
    callBtn.onclick = async () => {
        if (!username) {
            alert('Lütfen önce bir kullanıcı adı girin!');
            return;
        }
        try {
            localStream = await navigator.mediaDevices.getUserMedia(audioConstraints);
            localStream.getAudioTracks().forEach(track => track.enabled = false);
            isMicMuted = true;
            toggleMicBtn.innerText = 'Sesi Aç';
            toggleMicBtn.classList.remove('active');

            myUsernameSpan.innerText = username;
            myControlsDiv.style.display = 'flex';
            callBtn.style.display = 'none';
            
            socket.emit('call', { caller: username });
        } catch (e) {
            console.error("Mikrofona erişilemedi veya hata oluştu:", e);
            alert("Mikrofonunuza erişim izni vermelisiniz!");
        }
    };

    socket.on('call', async (data) => {
        if (!peerConnections[data.caller]) {
            const newPeerConnection = new RTCPeerConnection(config);
            // PeerConnection objesine kullanıcı adını ekle
            newPeerConnection.remoteUsername = data.caller;
            peerConnections[data.caller] = newPeerConnection;

            localStream.getTracks().forEach(track => newPeerConnection.addTrack(track, localStream));
            
            newPeerConnection.ontrack = e => {
                if (e.track.kind === 'audio') {
                    const audio = document.createElement("audio");
                    audio.srcObject = e.streams[0];
                    audio.autoplay = true;
                    document.body.appendChild(audio);
                } else if (e.track.kind === 'video') {
                    // Ekran akışını doğrudan oynatma, sadece sakla
                    sharedStreams[newPeerConnection.remoteUsername] = e.streams[0];
                }
            };
            
            newPeerConnection.onicecandidate = e => {
                if (e.candidate) {
                    socket.emit("ice-candidate", { to: data.caller, candidate: e.candidate });
                }
            };
            
            const offer = await newPeerConnection.createOffer();
            await newPeerConnection.setLocalDescription(offer);
            socket.emit('offer', { to: data.caller, offer: offer });
        }
    });

    socket.on('offer', async (data) => {
        if (data.to === username && !peerConnections[data.from]) {
            const newPeerConnection = new RTCPeerConnection(config);
            // PeerConnection objesine kullanıcı adını ekle
            newPeerConnection.remoteUsername = data.from;
            peerConnections[data.from] = newPeerConnection;

            localStream.getTracks().forEach(track => newPeerConnection.addTrack(track, localStream));

            newPeerConnection.ontrack = e => {
                if (e.track.kind === 'audio') {
                    const audio = document.createElement("audio");
                    audio.srcObject = e.streams[0];
                    audio.autoplay = true;
                    document.body.appendChild(audio);
                } else if (e.track.kind === 'video') {
                     // Ekran akışını doğrudan oynatma, sadece sakla
                    sharedStreams[newPeerConnection.remoteUsername] = e.streams[0];
                }
            };
            
            newPeerConnection.onicecandidate = e => {
                if (e.candidate) {
                    socket.emit("ice-candidate", { to: data.from, candidate: e.candidate });
                }
            };

            await newPeerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await newPeerConnection.createAnswer();
            await newPeerConnection.setLocalDescription(answer);
            socket.emit('answer', { to: data.from, answer: answer });
        }
    });
    
    socket.on('answer', async (data) => {
        if (data.to === username) {
            await peerConnections[data.from].setRemoteDescription(new RTCSessionDescription(data.answer));
        }
    });

    socket.on('ice-candidate', async (data) => {
        if (data.to === username) {
            try {
                await peerConnections[data.from].addIceCandidate(data.candidate);
            } catch(e){
                console.error("ICE adayında hata:", e);
            }
        }
    });

    socket.on('disconnect-user', (disconnectedUser) => {
        delete peerConnections[disconnectedUser];
        delete sharedStreams[disconnectedUser];
        const userItemRight = document.querySelector(`#userList li`);
        if (userItemRight && userItemRight.innerText === disconnectedUser) {
            userItemRight.remove();
        }
        const videoElement = document.querySelector(`video[data-username="${disconnectedUser}"]`);
        if (videoElement) {
            videoElement.remove();
        }
        const userItemLeft = document.querySelector(`#otherUsersList li[data-username="${disconnectedUser}"]`);
        if (userItemLeft) {
            userItemLeft.remove();
        }
    });

</script>
